<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Soulink Matches</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-gradient-to-br from-pink-50 to-yellow-100 text-gray-800 font-sans">
  <main class="p-6 max-w-3xl mx-auto">
    <h1 class="text-3xl font-bold text-center text-purple-700 mb-6">ðŸ’ž Your Soul Matches</h1>
    <div id="matchList" class="space-y-4"></div>
    <p id="statusMsg" class="text-center text-gray-600 mt-6"></p>
  </main>

  <script type="module">
    import { db } from './firebase-config.js';
    import { getAuth, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js';
    import { collection, getDocs } from 'https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js';

    const auth = getAuth();
    const matchList = document.getElementById("matchList");
    const statusMsg = document.getElementById("statusMsg");

    function calculateCompatibility(userA, userB) {
      let score = 0;
      if (userA.loveLanguage === userB.loveLanguage) score += 40;
      if (userA.relationshipType === userB.relationshipType) score += 20;
      if (userA.zodiac === userB.zodiac) score += 10;
      if (userA.chineseZodiac === userB.chineseZodiac) score += 10;
      if (userA.lifePath === userB.lifePath) score += 20;
      return score;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const currentUserId = user.uid;
      const usersSnapshot = await getDocs(collection(db, "users"));

      const allUsers = [];
      let currentUserData = null;

      usersSnapshot.forEach(doc => {
        const data = doc.data();
        if (doc.id === currentUserId) {
          currentUserData = data;
        } else {
          allUsers.push({ id: doc.id, ...data });
        }
      });

      if (!currentUserData) {
        statusMsg.textContent = "âŒ Your profile data could not be found.";
        return;
      }

      const matches = allUsers.map(other => {
        const score = calculateCompatibility(currentUserData, other);
        return { ...other, score };
      }).sort((a, b) => b.score - a.score);

      if (matches.length === 0) {
        statusMsg.textContent = "ðŸ˜• No matches found yet. You're the first soul here!";
        return;
      }

      matches.forEach(match => {
        const card = document.createElement("div");
        card.className = "bg-white rounded-lg shadow p-4";
        card.innerHTML = `
          <p class="font-bold text-xl text-pink-700">${match.name || 'Anonymous Soul'}</p>
          <p>ðŸ’– Compatibility: <strong>${match.score}%</strong></p>
          <p>Love Language: ${match.loveLanguage}</p>
          <p>Zodiac: ${match.zodiac} | Chinese: ${match.chineseZodiac}</p>
        `;
        matchList.appendChild(card);
      });
    });
  </script>
</body>
</html>
